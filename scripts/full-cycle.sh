#!/bin/bash

# ì™„ì „ ìë™í™” ì‚¬ì´í´: ì‘ì—… ì‹¤í–‰ â†’ ë¦¬ë·° â†’ ê°œì„ 

set -e

echo "ğŸ”„ Starting Full AI Development Cycle"
echo "======================================"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

# 1ë‹¨ê³„: Claudeë¡œ ì´ˆê¸° ì½”ë“œ ìƒì„±
echo ""
echo "ğŸ“ Step 1: Generate initial code with Claude"
echo "---------------------------------------------"
export MACHINE_NAME="local-mac"
"$SCRIPT_DIR/claude-runner.sh"

# ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
if [ ! -n "$(git log --oneline -1 | grep 'feat: Complete task')" ]; then
    echo "âš ï¸  No task was completed"
    exit 1
fi

# 2ë‹¨ê³„: Gemini ë¦¬ë·° ì‹¤í–‰
echo ""
echo "ğŸ” Step 2: Get code review from Gemini"
echo "---------------------------------------"

# ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
CHANGED_FILES=$(git diff HEAD~1 --name-only | grep -E '\.(js|ts|py|go|java)$' || true)

if [ -z "$CHANGED_FILES" ]; then
    echo "No code files to review"
    exit 0
fi

# Gemini ë¦¬ë·° ì‹¤í–‰
export CHANGED_FILES
node src/review.js || true

# 3ë‹¨ê³„: ë¦¬ë·° ê²°ê³¼ í™•ì¸
echo ""
echo "ğŸ“Š Step 3: Check review results"
echo "--------------------------------"

if [ -f "review-results.json" ] && [ -s "review-results.json" ]; then
    echo "Review suggestions found:"
    cat review-results.json | python3 -m json.tool || cat review-results.json
    
    # 4ë‹¨ê³„: Claudeë¡œ ì½”ë“œ ê°œì„ 
    echo ""
    echo "ğŸš€ Step 4: Apply improvements with Claude"
    echo "------------------------------------------"
    
    # ë¦¬ë·° ë‚´ìš©ì„ ìš”ì•½í•´ì„œ Claudeì—ê²Œ ì „ë‹¬
    REVIEW_SUMMARY=$(cat review-results.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
if isinstance(data, list):
    for item in data[:5]:  # ìƒìœ„ 5ê°œë§Œ
        if 'comment' in item:
            print(f\"- {item.get('comment', '')}\"[:100])
" 2>/dev/null || echo "Improve code quality")
    
    echo "Applying these improvements:"
    echo "$REVIEW_SUMMARY"
    
    # Claudeë¡œ ê°œì„  ì‹¤í–‰
    claude --dangerously-skip-permissions "Apply these code improvements: $REVIEW_SUMMARY" || true
    
    # 5ë‹¨ê³„: ê°œì„ ì‚¬í•­ ì»¤ë°‹
    echo ""
    echo "ğŸ’¾ Step 5: Commit improvements"
    echo "------------------------------"
    
    if [ -n "$(git status --porcelain)" ]; then
        git add -A
        git commit -m "refactor: Apply automated review improvements

Based on Gemini review:
$REVIEW_SUMMARY

Automated improvement cycle completed."
        
        echo "âœ… Improvements committed!"
        
        # PR ì—…ë°ì´íŠ¸
        if git remote -v | grep -q origin; then
            git push
            echo "ğŸ“¤ Pushed improvements to PR"
        fi
    else
        echo "No changes to commit"
    fi
else
    echo "No review suggestions to apply"
fi

echo ""
echo "ğŸ‰ Full cycle completed!"
echo ""
echo "Summary:"
echo "1. âœ… Code generated by Claude"
echo "2. âœ… Code reviewed by Gemini"
echo "3. âœ… Improvements applied by Claude"
echo "4. âœ… Changes committed and pushed"